library IEEE;
use IEEE.STD_LOGIC_1164.ALL;
use IEEE.STD_LOGIC_ARITH.ALL;
use IEEE.STD_LOGIC_UNSIGNED.ALL;

entity AirFryerFSM is
    Port (
        clk             : in std_logic;
        reset           : in std_logic;
        run             : in std_logic;
        OPEN_OVEN       : in std_logic;
        program         : in std_logic_vector(2 downto 0);
        tempNow         : in std_logic_vector(7 downto 0);
        timePreHeat     : in std_logic_vector(4 downto 0);
        timeTotal       : in std_logic_vector(4 downto 0);
        timeNow         : in std_logic_vector(4 downto 0);
		  foodIn          : out std_logic;
        ledStateIDLE    : out std_logic;
        ledStatePREHEAT : out std_logic;
        ledStateCOOK    : out std_logic;
        ledStateCOOL    : out std_logic
    );
end AirFryerFSM;

architecture Behavioral of AirFryerFSM is
    type state_type is (IDLE, PREHEAT, COOK, FINISH, COOL);
    signal state, next_state: state_type;
	 signal s_foodIn         : std_logic := '0';

begin
    -- State Machine Process
    process(clk, reset)
    begin
        if reset = '1' then
            state <= IDLE;
        elsif rising_edge(clk) then
            state <= next_state;
        end if;
    end process;

    -- Next State Logic
    process(state, run, OPEN_OVEN, program, timePreHeat, timeTotal, timeNow, tempNow)
    begin
        -- Default values for outputs
        ledStateIDLE <= '0';
        ledStatePREHEAT <= '0';
        next_state <= state;

        case state is
            when IDLE =>
                ledStateIDLE <= '1';
                if run = '1' then
							next_state <= PREHEAT;
                end if;

            when PREHEAT =>
                ledStatePREHEAT <= '1';
					 if timePreHeat = "00000" then
						next_state <= COOK;
					 else
						 if heat and OPEN_OVEN = '1' then
							s_foodIn <= '1';
						 end if;
						 
						 if s_foodIn = '1' then
							  next_state <= COOK;
					    end if;
                end if;

            when COOK =>
                ledStateCOOK <= '1';
                if timeNow = "00000" and OPEN_OVEN = '1' then
                    next_state <= COOL;
                end if;

            when COOL =>
                ledStateCOOL <= '1';
                if unsigned(tempNow) <= 20 then
                    next_state <= IDLE;
                end if;

            when others =>
                next_state <= IDLE;
        end case;
    end process;

end Behavioral;